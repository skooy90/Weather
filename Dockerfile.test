FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# 기본 패키지 설치 및 Node.js 설정
RUN apt-get update && \
    apt-get install -y curl gnupg software-properties-common && \
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    add-apt-repository -y ppa:ondrej/php && \
    curl -fsSL https://pgp.mongodb.com/server-6.0.asc | gpg -o /usr/share/keyrings/mongodb-server-6.0.gpg --dearmor && \
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-6.0.list && \
    apt-get update && \
    apt-get install -y nodejs

# PHP와 필요한 확장 프로그램 설치
RUN apt-get update && apt-get install -y \
    php8.2 \
    php8.2-fpm \
    php8.2-cli \
    php8.2-common \
    php8.2-mysql \
    php8.2-zip \
    php8.2-gd \
    php8.2-mbstring \
    php8.2-curl \
    php8.2-xml \
    php8.2-bcmath \
    php8.2-mongodb \
    php8.2-intl \
    composer \
    mongodb-database-tools \
    && rm -rf /var/lib/apt/lists/*

# 작업 디렉토리 설정
WORKDIR /app

# package.json과 package-lock.json 복사
COPY package*.json ./

# 의존성 설치
RUN npm install

# composer.json과 composer.lock 복사
COPY composer.* ./

# PHP 의존성 설치 및 업데이트
RUN composer update --no-interaction && \
    composer install --no-interaction --no-scripts

# 소스 코드 복사
COPY . .

# 테스트 환경 변수 설정
ENV NODE_ENV=test
ENV MONGODB_URI=mongodb://mongodb:27017/weather_test

# 테스트 실행 명령
CMD ["npm", "test"] 